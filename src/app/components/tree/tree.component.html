<div class="pad-l-md pad-r-md my-scroll" style="overflow-y: scroll;height: 90vh;" fxFlex="35">
   
  <div class="row" class="pad-all-sm">
    
    <button mat-icon-button (click)="edit=!edit">
      <mat-icon>edit</mat-icon>
    </button>
    
    <button mat-icon-button (click)="toggleTree()">
      <mat-icon>{{openAll ? 'unfold_less' : 'unfold_more'}}</mat-icon>
    </button>
    
    <button mat-raised-button color="primary" (click)="addNewCategory()" class="mrgn-l-sm">
      Add Category
    </button>

    <button mat-button [matMenuTriggerFor]="versionsMenu" (click)="getTreeVersions()">
      Versions
    </button>

    <mat-menu #versionsMenu="matMenu" class="my-scroll">
      <button mat-menu-item color="accent" *ngFor="let version of treeVersions;index as i"
        (click)="renderTreeVersion(version.id)">
        <b>{{i+1}})</b>
        {{ version.created_at | date: 'dd/MM/yyyy HH:mm:ss' }}
      </button>
    </mat-menu>

    <button mat-raised-button color="primary" (click)="openGalleryDialog()">
      Gallery
    </button>

  </div>

  <ng-container *ngTemplateOutlet="categoryTree; context: { $implicit: {cats: apiService.categories, parent: {}} }"></ng-container>

  <button mat-raised-button color="primary" (click)="saveTree()" class="mrgn-t-sm">
    Save
    <mat-icon>save</mat-icon>
  </button>

</div>

<!--== TREEE =====================-->

<ng-template  #categoryTree let-categories>

  <mat-accordion displayMode="flat" class="categories-accordeon" multi="true" cdkDropList (cdkDropListDropped)="drop($event, categories)">
    <mat-expansion-panel cdkDrag
      *ngFor="let category of categories.cats;index as i"
      [hideToggle]="!category.childsNum"
      [disabled]="!category.childsNum"
      togglePosition="before">
      
      
      <mat-expansion-panel-header style="overflow: visible;">
        <mat-panel-title style="overflow: visible;">
          <span [ngClass]="!category.childsNum ? 'hidden-indicator' : ''"></span>
          <app-icons *ngIf="edit" 
            [selectedIcon]="category.icon"
            (onSelectIcon)="category.icon=$event"
            >
          </app-icons>
          <mat-icon *ngIf="!edit" class="mrgn-r-sm">{{category.icon}}</mat-icon>
          <div class="row" style="width: 100%;overflow: visible;">

            <div class="col-xs-4 col-md-6">
              <div class="top-7">

                <mat-form-field *ngIf="edit" (click)="$event.stopPropagation();">
                  <mat-label>{{category.title}}</mat-label>
                  <input matInput type="text"
                   (keydown)="$event.stopPropagation()"
                   [(ngModel)]="category.title" (focus)="category.title === 'images' ? category.title = '' : ''">
                </mat-form-field>

                <span 
                  *ngIf="!edit"
                  style="cursor: pointer" 
                  (click)="previewAssets(category, $event)">
                  {{category.title}}
                </span>

                <span 
                  style="display: inline-block;top:-13px;"
                  *ngIf="category.files && category.files.length"
                  class="mrgn-l-md"
                  [matBadge]="category.files.length" 
                  matBadgeSize="small" matBadgePosition="after">
                </span>

                <!-- <button mat-button
                *ngIf="category.files && category.files.length" 
                color="primary" 
                (click)="$event.stopPropagation();previewAssets(category)">
                View Assets
                ({{category?.files ? category.files.length : 0}})
              </button> -->

                
              </div>

              

            </div>

            <div class="col-xs-8 col-md-6 end-xs">
              <!-- <mat-icon>{{category.icon}}</mat-icon> -->

              <button 
                mat-button color="primary" 
                (click)="$event.stopPropagation();openDropZone(category)">
                Add Assets
              </button>

              <button mat-button mat-icon-button (click)="$event.stopPropagation();addChildToCategory(category);">
                <mat-icon>add_circle</mat-icon>
              </button>
             
              <button
                [disabled]="(category.childsNum > 0) || (category?.files && (category?.files?.length !== 0))" 
                color="warn" 
                mat-button mat-icon-button (click)="removeCategory(categories.parent, i);">
                <mat-icon>remove_circle</mat-icon>
                <!--
                {{category.childsNum}} - {{category.files ? 'Yes' : 'Bo'}}
                -->
              </button>

            </div>

  
          </div>
          
        </mat-panel-title>
    </mat-expansion-panel-header>

    <mat-panel-description>	
      <mat-progress-bar mode="indeterminate" *ngIf="!category.childs"></mat-progress-bar>
    </mat-panel-description>
    <ng-container *ngIf="category.childs">
      <ng-container *ngTemplateOutlet=" categoryTree; context: { $implicit: {cats: category.childs, parent: category} }">
      </ng-container>
    </ng-container>
    </mat-expansion-panel>

  </mat-accordion>

</ng-template>

<!--== DIALOGS =====================-->

<ng-template #previewAssetsDialog>
  
  <div class="my-scroll" style="height: 75vh;">
    <div class="row around-xs" style="margin: 0" [sortablejs]="selectedCategory.files">
      <div *ngFor="let file of selectedCategory.files;index as i" 
        class="pad-all-sm mrgn-all-sm gallery-card">

        <div class="gallery-card-overlay">
          <div style="width: 100%">
            <button mat-icon-button (click)="openEditAssetDialog(file, i)">
              <mat-icon>edit</mat-icon>
            </button>
            <button mat-icon-button (click)="coreService.selectedAssets.push(file)">
              <mat-icon>done</mat-icon>
            </button>
          </div>
        </div> 
        <div class="gallery-card-selected" *ngIf="coreService.selectedAssets.includes(file)">
          <div style="width: 100%">
            <button mat-icon-button class="mat-green" 
              (click)="coreService.selectedAssets.splice(coreService.selectedAssets.indexOf(file), 1)">
              <mat-icon>check</mat-icon>
            </button>          
          </div>
        </div>

        <div class="bg-image-contain" style="width: 150px;height: 150px;" 
          [style.backgroundImage]="'url('+apiService.imgPath+(file | apiPath) +')'">
        </div>
      </div>
    </div>
    <!-- {{coreService.selectedAssets|json}} -->
  </div>
    
</ng-template>

<ng-template #editAssetDialog>
  <div class="my-scroll" style="height: 95vh;margin-bottom: -5px;">
    <app-canvas 
      *ngIf="this.selectedFilePath" 
      [selectedFileIndex]="selectedFileIndex"
      [category]="selectedCategory"
      [selectedFilePath]="selectedFilePath">
    </app-canvas>
  </div>
</ng-template>

<ng-template #galleryDialog>
  <div class="my-scroll" style="height: 75vh;">
    <app-gallery></app-gallery>
  </div>
</ng-template>

<ng-template #galleryClbkDialog>
  <div class="my-scroll" style="height: 75vh;">
    <app-gallery [hasClbk]="true" (onAddSelected)="onAddSelected()"></app-gallery>
  </div>
</ng-template>

<ng-template #dropZoneDialog>
  <div class="column pad-all-lg" style="min-width: 50vw">
    <app-dropzone 
      (onAddFile)="onAddFile($event)"
      (onSelectFile)="onSelectFile($event)">
    </app-dropzone>
    <div class="mrgn-all-lg">
      OR
    </div>
    <button mat-raised-button color="primary" (click)="openGalleryClbkDialog()">
      Choose from Gallery
    </button>
    
    <!-- <app-paste-url 
      (onAddFile)="onAddFile($event)">
    </app-paste-url> -->

  </div> 
</ng-template>

